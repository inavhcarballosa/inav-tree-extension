let worksheet,_timer;(async function(){try{await tableau.extensions.initializeAsync()}catch(e){console.warn(e)}if(!(tableau?.extensions?.dashboardContent))return;const e=tableau.extensions.dashboardContent.dashboard;if(!(worksheet=e.worksheets[0]))return console.error("No worksheets found on this dashboard. Add one to the dashboard, not just the workbook."),void 0;worksheet.addEventListener(tableau.TableauEventType.FilterChanged,n);worksheet.addEventListener(tableau.TableauEventType.MarkSelectionChanged,n);await t()})();function n(){clearTimeout(_timer),_timer=setTimeout(t,150)}async function a(){const e=await worksheet.getSummaryDataReaderAsync(),t=await e.getAllPagesAsync();await e.releaseAsync();const n=t.columns.map(e=>({name:e.fieldName,dataType:e.dataType})),a=t.data.map(e=>{const t={};return e.forEach((e,a)=>{t[n[a].name]=e.formattedValue??e.value}),t});return{cols:n,rows:a}}function i(e,t){const n=e.filter(e=>"string"===e.dataType||"varchar"===e.dataType||void 0===e.dataType).map(e=>e.name),a=n.find(e=>/parent/i.test(e));if(a){const e=n.find(e=>e!==a),t=n.find(t=>t!==a&&t!==e)||e;return{mode:"parentChild",id:e,parent:a,label:t}}{const[e,a,i]=n.slice(0,3);if(!e||!a||!i)throw new Error("Not enough string columns to infer hierarchy (need at least 3).");return{mode:"itemCategoryChild",item:e,category:a,child:i}}}function r(e,t){if("parentChild"===t.mode){const{ id:n,parent:a,label:i}=t,r=e.map(e=>({id:String(e[n]??""),parent:e[a]?String(e[a]):null,label:e[i]??e[n]})).filter(e=>e.id),o=new Set(r.map(e=>e.id)),c=r.filter(e=>!e.parent||o.has(e.parent)),s=d3.stratify().id(e=>e.id).parentId(e=>e.parent),l=s(c);l.each(e=>{e.label=e.data.label||e.id});const d=d3.tree().nodeSize([26,200]);return d(l),{nodes:l.descendants(),links:l.links()}}{const{item:n,category:a,child:i}=t,r="__root__",o=new Map,c=[];function s(e,t){o.has(e)||o.set(e,{id:e,label:t})}s(r,"Root"),e.forEach(e=>{const t=String(e[n]??""),l=String(e[a]??""),d=String(e[i]??"");if(!t||!l||!d)return;const f=`item:${t}`,h=`cat:${t}::${l}`,u=`child:${t}::${l}::${d}`;s(f,t),s(h,l),s(u,d),c.push({source:r,target:f}),c.push({source:f,target:h}),c.push({source:h,target:u})});const l=(e,t)=>Array.from(new Map(e.map(e=>[t(e),e])).values()),d=l(c,e=>`${e.source}->${e.target}`),f={};o.forEach(e=>{f[e.id]=[]}),d.forEach(e=>{f[e.source].push(e.target)});function h(e){return{id:e,name:o.get(e)?.label||e,children:(f[e]||[]).map(h)}}const u=d3.hierarchy(h(r),e=>e.children),p=d3.tree().nodeSize([26,200]);p(u);const g=u.descendants().map(e=>({id:e.data.id,label:e.data.name,x:e.x,y:e.y})),m=new Map(g.map(e=>[e.id,e])),y=d.filter(e=>m.has(e.source)&&m.has(e.target)).map(e=>({source:m.get(e.source),target:m.get(e.target)}));return{nodes:g,links:y}}}async function t(){try{const{cols:e,rows:n}=await a(),o=i(e,n),c=r(n,o);l(c.nodes,c.links)}catch(e){console.error("Render error:",e),l([],[])}}function l(e,t){const n=document.getElementById("viz"),a=n.clientWidth||1200,i=Math.max(600,(e.length||10)*28);d3.select("#viz").selectAll("*").remove();const r=d3.select("#viz").append("svg").attr("width",a).attr("height",i),o=r.append("g").attr("transform","translate(40,40)");r.call(d3.zoom().on("zoom",e=>o.attr("transform",e.transform))),o.append("g").selectAll("path").data(t).join("path").attr("fill","none").attr("stroke","#2dd4bf").attr("stroke-opacity",.7).attr("stroke-width",1.2).attr("d",e=>`
      M${e.source.y},${e.source.x}
      C${(e.source.y+e.target.y)/2},${e.source.x}
       ${(e.source.y+e.target.y)/2},${e.target.x}
       ${e.target.y},${e.target.x}`);const c=o.append("g").selectAll("g.node").data(e).join("g").attr("class","node").attr("transform",e=>`translate(${e.y},${e.x})`);c.append("circle").attr("r",5).attr("stroke","#a3a3a3").attr("fill","#111"),c.append("text").attr("dy","0.32em").attr("x",10).text(e=>e.label??e.id).style("font-family","system-ui, sans-serif").style("font-size","12px").style("fill","#e5e5e5")}